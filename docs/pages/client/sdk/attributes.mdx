# Attributes

Attributes attach key-value metadata to traces and issues. The `Attributes` type is thread-safe and available through both global configuration and per-request context.

## Attributes API

### SetTag

Set a string attribute:

```go
attributes.SetTag("user_id", "12345")
attributes.SetTag("tenant", "acme-corp")
```

### SetTagJson

Set an attribute with a JSON-serialized value. The value is marshaled to JSON and stored as a string. In the dashboard, JSON values are displayed with formatting.

```go
attributes.SetTagJson("cart_items", []string{"item1", "item2", "item3"})
attributes.SetTagJson("user_prefs", map[string]bool{"notifications": true})
```

Returns an error if JSON marshaling fails.

### GetTag

Retrieve a single attribute value:

```go
value, ok := attributes.GetTag("user_id")
if ok {
    fmt.Println("User:", value)
}
```

### GetTags

Get a copy of all attributes as a `map[string]string`:

```go
allTags := attributes.GetTags()
for k, v := range allTags {
    fmt.Printf("%s = %s\n", k, v)
}
```

Returns a copy — modifying the returned map does not affect the original attributes.

### Clone

Create an independent copy of the attributes:

```go
copy := attributes.Clone()
copy.SetTag("extra", "value") // Does not affect original
```

### Clear

Remove all attributes:

```go
attributes.Clear()
```

## Global Attributes

### ConfigureAttributes

Set attributes that apply to all traces and issues. Call once at application startup:

```go
traceway.ConfigureAttributes(func(s *traceway.Attributes) {
    s.SetTag("environment", "production")
    s.SetTag("region", "us-east-1")
    s.SetTag("service", "user-api")
    s.SetTag("version", os.Getenv("APP_VERSION"))
})
```

Global attributes are inherited by every request's attribute set.

## Context-Based Attributes

### WithAttributes

Create a new context with a cloned and modified attribute set:

```go
ctx = traceway.WithAttributes(ctx, func(a *traceway.Attributes) {
    a.SetTag("operation", "checkout")
    a.SetTag("step", "payment")
})
```

This clones the attributes from the current context, applies the modifications, and stores the new set in the returned context. The original context's attributes are unchanged.

### GetAttributesFromContext

Retrieve attributes from a Go context:

```go
attributes := traceway.GetAttributesFromContext(ctx)
attributes.SetTag("user_id", userID)
```

If the context has no attributes, returns a clone of the global attributes. If the context is `nil`, also returns a clone of the global attributes.

## Attribute Inheritance

Per-request attributes start as a clone of the global attributes. Request-level values override global values for the same key:

```
Global Attributes          Request Attributes         Final Tags
─────────────────          ──────────────────         ──────────
environment: prod     +    user_id: 123         =    environment: prod
region: us-east-1          tenant: acme               region: us-east-1
service: user-api                                     service: user-api
                                                      user_id: 123
                                                      tenant: acme
```

## Usage in Middleware

Add attributes for all requests in a Gin middleware:

```go
func authMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        user := authenticate(c)
        attributes := traceway.GetAttributesFromContext(c.Request.Context())
        attributes.SetTag("user_id", user.ID)
        attributes.SetTag("organization", user.OrgID)
        c.Next()
    }
}
```

## Usage in Handlers

Add request-specific attributes:

```go
func createOrderHandler(c *gin.Context) {
    attributes := traceway.GetAttributesFromContext(c.Request.Context())
    attributes.SetTag("action", "create_order")
    attributes.SetTag("item_count", fmt.Sprintf("%d", len(items)))
}
```
