# HTTP Middleware

The `traceway_http` package provides middleware for standard `net/http` servers. It automatically creates a trace for each request, captures panics, and detects client IP addresses.

## Installation

```bash
go get go.tracewayapp.com
```

## Basic Setup

```go
package main

import (
    "net/http"

    tracewayhttp "go.tracewayapp.com/traceway_http"
)

func main() {
    mux := http.NewServeMux()
    mux.HandleFunc("/api/users", getUsers)
    mux.HandleFunc("/api/orders", getOrders)

    // Wrap with Traceway middleware
    handler := tracewayhttp.New(
        "your-token@http://localhost:8082/api/report",
    )(mux)

    http.ListenAndServe(":8080", handler)
}
```

The `New` function returns `func(http.Handler) http.Handler`, so you chain it around your handler.

## What Gets Captured

The middleware automatically captures for every request:

| Data | Description |
|------|-------------|
| **Endpoint** | HTTP method + URL path (e.g., `GET /api/users`) |
| **Duration** | Request processing time |
| **Status Code** | HTTP response status |
| **Body Size** | Response body size in bytes |
| **Client IP** | Detected from headers or connection |
| **Panics** | Recovered and captured with full stack trace |

## ResponseWriter Wrapping

The middleware wraps the `http.ResponseWriter` to track the response status code and bytes written. The wrapped writer preserves the original writer's `Flusher`, `Hijacker`, and `Unwrap` interfaces.

## Client IP Detection

Client IP is resolved in this order:

1. `X-Forwarded-For` header (first IP in the list)
2. `X-Real-IP` header
3. `RemoteAddr` from the connection

## Error Detection

A request is considered an error when:

- A **panic** occurs during handler execution
- The response status code is **>= 500**

Error traces use the error sample rate for sampling decisions.

## Panic Handling

When a panic occurs, the middleware:

1. Recovers the panic
2. Captures the full stack trace as an issue
3. Either re-panics (default, `WithRepanic(true)`) or responds with 500

## Next Steps

- [Configuration](/http-middleware/configuration) — All options and passthrough settings
- [Error Recording](/http-middleware/error-recording) — Control what request data is captured on errors
